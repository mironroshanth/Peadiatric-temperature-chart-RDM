<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <title>My Account</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 0;
            background: url('https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/tc.jpeg') no-repeat center center fixed;
            background-size: cover;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
            margin: 20px auto;
        }
        /* Styles for buttons and labels */
        button, label {
            background: linear-gradient(45deg, #6a11cb, #2575fc);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s ease, box-shadow 0.3s ease;
            width: 100%; /* Make them full width in the container */
            margin: 5px 0;
            font-size: 14px;
            text-align: center; /* Center the text/icon */
            display: inline-block; /* Allow padding/margin */
            box-sizing: border-box; /* Include padding and border in width */
        }
        button:hover, label:hover {
            background: linear-gradient(45deg, #2575fc, #6a11cb);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        /* Style specifically for the upload label to look like a button */
        label[for="uploadFile"] {
             display: block; /* Make it behave like a block button */
             margin-bottom: 15px; /* Add space below the upload label */
        }

        #qrcode {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .selected {
            background-color: #e0e0e0; /* Highlight selected file */
            color: #333; /* Darker text for contrast */
            font-weight: bold;
        }
        #fileList {
             list-style: none; /* Remove bullets */
             padding: 0; /* Remove default padding */
             margin: 10px 0;
             border: 1px solid #ddd;
             border-radius: 4px;
             max-height: 200px; /* Limit height and add scroll if many files */
             overflow-y: auto;
             background-color: #fff; /* Ensure list background is white */
        }
        #fileList li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
            word-break: break-word; /* Break long filenames */
        }
         #fileList li:last-child {
            border-bottom: none; /* No border on the last item */
        }
         #fileList li:hover {
            background-color: #f0f0f0; /* Light hover effect */
         }
        #searchBar {
            margin-bottom: 10px;
            width: calc(100% - 22px); /* Adjust width considering padding and border */
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Include padding and border in element's total width */
        }
        /* Style for user info text */
        #user-info {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px dashed #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        #user-info p {
             margin: 5px 0;
             text-align: left;
             font-size: 14px;
        }
         #sign-out-btn {
             background: #dc3545; /* Red color for sign out */
         }
         #sign-out-btn:hover {
             background: #c82333;
         }
         button:disabled, label:disabled {
             background-color: #ccc !important; /* Grey out disabled buttons/labels */
             cursor: not-allowed !important;
             box-shadow: none !important;
         }
          label[for="uploadFile"][disabled] {
              opacity: 0.5;
          }
    </style>
</head>
<body>
    <div class="container">
        <h1>Your Account</h1>
        <div id="user-info">
            <!-- User info will be displayed here by JavaScript -->
             <p>Loading user info...</p>
        </div>

        <h2>Your Charts</h2>

        <!-- Add search bar input -->
        <input type="text" id="searchBar" placeholder="Search files..." disabled>

        <ul id="fileList">
            <!-- File list will be populated by JavaScript -->
             <li>Loading files...</li>
        </ul>

        <button id="loadFile" disabled>Load Selected File</button>
        <button id="downloadFile" disabled>Download Selected File</button>
        <button id="deleteFile" disabled>Delete Selected File</button>

        <input type="file" id="uploadFile" accept=".json" style="display: none;" disabled />
        <p style="font-size: 12px; text-align: center; margin-top: 15px;">You can upload and view JSON files by clicking 'Upload chart'.</p>
        <label for="uploadFile" disabled>Upload chart</label>

        <p style="font-size: 12px; text-align: center; margin-top: 15px;">By getting a QR code, you can share a link to your chart account.</p>
        <button id="getQRCode" disabled>Get QR Code Link</button>
        <div id="qrcode"></div>
        <button id="printQRCode" style="display: none;">Print QR Code</button>

        <button onclick="newChart()">Feedback form</button>
        <button onclick="goBack()"><i class="fas fa-arrow-left"></i> Back</button>

        <button id="sign-out-btn" disabled>Sign Out</button> <!-- Added Sign Out Button -->
    </div>

    <!-- Firebase SDKs -->
    <!-- Using a recent version (10.11.0 as of this example), check Firebase docs for the latest recommended -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        // Firebase configuration (keep your existing config)
        const firebaseConfig = {
            apiKey: "AIzaSyB_iG1hCwRs82h_EoLmVERfHKxO2fh-M-Q",
            authDomain: "temperature-chart-47839.firebaseapp.com",
            projectId: "temperature-chart-47839",
            storageBucket: "temperature-chart-47839.firebasestorage.app",
            messagingSenderId: "764348196897",
            appId: "1:764348196897:web:10e513dc51e6e839665b60",
            databaseURL: "https://temperature-chart-47839-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = app.auth();
        const database = app.database();

        // Global variables
        let currentUserId = null;
        let userFilesRef = null;
        let userFilesMetadata = {}; // Stores only metadata now

        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const userInfoDiv = document.getElementById('user-info');
            const fileListElement = document.getElementById('fileList');
            const searchBar = document.getElementById('searchBar');
            const loadFileButton = document.getElementById('loadFile');
            const downloadFileButton = document.getElementById('downloadFile');
            const deleteFileButton = document.getElementById('deleteFile');
            const uploadFileInput = document.getElementById('uploadFile');
            const uploadFileLabel = document.querySelector('label[for="uploadFile"]');
            const getQRCodeButton = document.getElementById('getQRCode');
            const printQRCodeButton = document.getElementById('printQRCode');
            const qrcodeContainer = document.getElementById('qrcode');
            const signOutButton = document.getElementById('sign-out-btn');

            // Auth state listener
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUserId = user.uid;
                    userInfoDiv.innerHTML = `
                        <p>Email: ${user.email}</p>
                        <p>User ID: ${currentUserId}</p>
                    `;

                    // Initialize references to the new structure
                    userFilesRef = database.ref('patients/' + currentUserId + '/file_metadata');

                    // Load file list
                    loadFileList();

                    // Enable UI elements
                    searchBar.disabled = false;
                    uploadFileInput.disabled = false;
                    uploadFileLabel.style.opacity = 1;
                    uploadFileLabel.style.cursor = 'pointer';
                    getQRCodeButton.disabled = false;
                    signOutButton.disabled = false;
                } else {
                    // User signed out
                    currentUserId = null;
                    if (userFilesRef) userFilesRef.off('value');
                    userFilesRef = null;
                    userFilesMetadata = {};
                    
                    // Update UI
                    userInfoDiv.innerHTML = '<p>No user signed in. Please sign in to view your account.</p>';
                    fileListElement.innerHTML = '<li>Please sign in to view your files.</li>';
                    
                    // Disable elements
                    searchBar.value = '';
                    searchBar.disabled = true;
                    [loadFileButton, downloadFileButton, deleteFileButton, getQRCodeButton, signOutButton].forEach(btn => {
                        btn.disabled = true;
                    });
                    uploadFileInput.disabled = true;
                    uploadFileLabel.style.opacity = 0.5;
                    uploadFileLabel.style.cursor = 'not-allowed';
                    qrcodeContainer.innerHTML = '';
                    printQRCodeButton.style.display = 'none';
                    
                    // Redirect to sign-in
                    window.location.href = 'https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Sign%20in.html';
                }
            });

            // Load file list (metadata only)
            function loadFileList() {
                if (!userFilesRef) return;

                fileListElement.innerHTML = '<li class="loading">Loading files...</li>';

                userFilesRef.orderByChild('timestamp').on('value', (snapshot) => {
                    userFilesMetadata = snapshot.val() || {};
                    fileListElement.innerHTML = '';

                    // Fix: Use snapshot.forEach to handle both array/object and preserve order
                    let hasFiles = false;
                    snapshot.forEach(childSnap => {
                        hasFiles = true;
                        const fileKey = childSnap.key;
                        const fileMeta = childSnap.val();
                        const li = document.createElement('li');
                        li.textContent = fileMeta.fileName || `File_${fileKey}`;
                        li.dataset.key = fileKey;
                        li.addEventListener('click', function() {
                            document.querySelectorAll('#fileList li').forEach(item => {
                                item.classList.remove('selected');
                            });
                            this.classList.add('selected');
                        });
                        fileListElement.appendChild(li);
                    });

                    if (!hasFiles) {
                        fileListElement.innerHTML = '<li>No saved charts found.</li>';
                    }
                }, (error) => {
                    console.error("File list error:", error);
                    fileListElement.innerHTML = '<li>Error loading files.</li>';
                });
            }

            // Get full file data when needed
            async function getFullFileData(fileKey) {
                try {
                    const snapshot = await database.ref(`patients/${currentUserId}/file_data/${fileKey}`).once('value');
                    return snapshot.val();
                } catch (error) {
                    console.error("Error loading file data:", error);
                    throw error;
                }
            }

            // Load file button
            loadFileButton.addEventListener('click', async function() {
                const selectedFileItem = document.querySelector('#fileList .selected');
                if (!selectedFileItem) {
                    alert('Please select a file from the list.');
                    return;
                }

                const fileKey = selectedFileItem.dataset.key;
                try {
                    const fileData = await getFullFileData(fileKey);
                    
                    if (fileData) {
                        sessionStorage.setItem('chartDataForLoad', JSON.stringify(fileData));
                        sessionStorage.setItem('loadedChartSourcePage', 
                            userFilesMetadata[fileKey]?.sourcePage || 'Temperature Chart');
                        
                        const targetPage = determineTargetPage(userFilesMetadata[fileKey]?.sourcePage);
                        if (targetPage) {
                            window.location.href = targetPage;
                        } else {
                            alert('Could not determine target page. Loading default chart.');
                            window.location.href = 'https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Temperature%20chart.html';
                        }
                    } else {
                        throw new Error('File data not found');
                    }
                } catch (error) {
                    console.error("Load error:", error);
                    alert('Error loading file: ' + error.message);
                }
            });

            // Download file button
            downloadFileButton.addEventListener('click', async function() {
                const selectedFileItem = document.querySelector('#fileList .selected');
                if (!selectedFileItem) {
                    alert('Please select a file from the list.');
                    return;
                }

                const fileKey = selectedFileItem.dataset.key;
                try {
                    const fileData = await getFullFileData(fileKey);
                    const fileName = userFilesMetadata[fileKey]?.fileName || `chart_${fileKey}`;
                    
                    const blob = new Blob([JSON.stringify({
                        fileName: fileName,
                        timestamp: userFilesMetadata[fileKey]?.timestamp,
                        sourcePage: userFilesMetadata[fileKey]?.sourcePage,
                        fileData: fileData
                    }, null, 2)], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${fileName}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error("Download error:", error);
                    alert('Error downloading file: ' + error.message);
                }
            });

            // Upload file
            uploadFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const fileContent = JSON.parse(e.target.result);
                        
                        if (!fileContent.fileData) {
                            throw new Error('Invalid file format - missing fileData');
                        }

                        const newKey = database.ref().child('patients/' + currentUserId + '/file_metadata').push().key;
                        const timestamp = firebase.database.ServerValue.TIMESTAMP;
                        const fileName = file.name.replace('.json', '');
                        
                        const updates = {
                            [`patients/${currentUserId}/file_metadata/${newKey}`]: {
                                fileName: fileName,
                                timestamp: timestamp,
                                sourcePage: fileContent.sourcePage || 'Temperature Chart'
                            },
                            [`patients/${currentUserId}/file_data/${newKey}`]: fileContent.fileData
                        };

                        await database.ref().update(updates);
                        alert('File uploaded successfully!');
                    } catch (error) {
                        console.error("Upload error:", error);
                        alert('Error uploading file: ' + error.message);
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsText(file);
            });

            // Delete file
            deleteFileButton.addEventListener('click', async function() {
                const selectedFileItem = document.querySelector('#fileList .selected');
                if (!selectedFileItem) {
                    alert('Please select a file from the list.');
                    return;
                }

                const fileKey = selectedFileItem.dataset.key;
                const fileName = selectedFileItem.textContent;
                
                if (confirm(`Are you sure you want to delete "${fileName}"?`)) {
                    try {
                        const updates = {};
                        updates[`patients/${currentUserId}/file_metadata/${fileKey}`] = null;
                        updates[`patients/${currentUserId}/file_data/${fileKey}`] = null;
                        
                        await database.ref().update(updates);
                        alert('File deleted successfully');
                    } catch (error) {
                        console.error("Delete error:", error);
                        alert('Error deleting file: ' + error.message);
                    }
                }
            });

            // [Keep all your existing QR code, navigation, and sign-out functions]
            function determineTargetPage(sourcePage) {
                const pages = {
                    'Day 2': 'https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Day%202.html',
                    'Temperatures recorded in all five days': 'https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Temperatures%20recorded%20in%20all%20five%20days.html',
                    'Temperature Chart': 'https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Temperature%20chart.html'
                };
                return pages[sourcePage] || null;
            }

            // [Rest of your existing functions (goBack, newChart, etc.)]
        });
    </script>

</body>
</html>
