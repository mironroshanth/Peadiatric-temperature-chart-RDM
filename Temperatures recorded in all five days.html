<!DOCTYPE html>
<html>
<head>

    <title>Temperature Chart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <!-- Assuming styles.css is for the navigation and general layout, keep it linked -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
    /* --- Your existing CSS styles are included here --- */
    body {
        font-family: Arial, Helvetica, sans-serif;
        margin: 0;
        background-color: rgba(255, 255, 255, 0.699);
    }
    .topnav {
    		overflow: hidden;
    		background: linear-gradient(45deg, #6a11cb, #2575fc);
    		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    		width: 100%;
    		z-index: 1;
    		display: flex;
    		justify-content: space-between;
    		align-items: center;
    		padding: 3px 16px;
    		position: -webkit-sticky; /* For Safari */
    		position: sticky; /* Sticky behavior */
    		top: 0; /* Stick to the top when scrolling */
    		margin: 0;
		}
    .topnav .menu-icon {
        font-size: 26px;
        cursor: pointer;
        color: white;
        display: none; /* Initially hidden */
    }
    .topnav .logo {
        color: white;
        font-size: 20px;
        text-decoration: none;
    }
    .topnav a.active {
        background: #000000;
        color: white;
    }
    .sidebar {
        height: 100%;
        width: 0;
        position: fixed;
        z-index: 2;
        top: 0;
        left: 0;
        background-color: #302e2e;
        overflow-x: hidden;
        transition: 0.3s;
        padding-top: 60px;
    }
    .sidebar a {
        padding: 10px 15px;
        text-decoration: none;
        font-size: 18px;
        color: #fff;
        display: block;
        transition: 0.3s;
    }
    .sidebar a:hover {
        color: #f1f1f1b7;
    }
    .sidebar .close-btn {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 36px;
        margin-left: 50px;
        color: white;
    }
    .sidebar a.active {
        background: #0f0f0f;
        color: white;
    }
    .container {
        margin-top: 60px;
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        width: 300px;
        margin: 80px auto;
    }
    input {
        margin: 10px 0;
        padding: 8px;
        width: 100%;
        box-sizing: border-box;
        font-family: Arial, sans-serif;
    }
    button {
        background: linear-gradient(45deg, #6a11cb, #2575fc);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s ease, box-shadow 0.3s ease;
        width: 100%;
        margin: 5px 0;
    }
    button:hover {
        background: linear-gradient(45deg, #2575fc, #6a11cb);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .save-button {
        background: linear-gradient(45deg, #6a11cb, #2575fc);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s ease, box-shadow 0.3s ease;
        width: 100%;
        margin: 5px 0;
        text-decoration: none; /* Add this line to remove underline */
    }
     .save-button:disabled { /* Style for disabled save button */
         background-color: #ccc;
         cursor: not-allowed;
         box-shadow: none;
    }
    .ac-button {
        background: linear-gradient(45deg, #be0d0d, #ff4d4d);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s ease, box-shadow 0.3s ease;
    }
    .ac-button:hover {
        background: linear-gradient(45deg, #ff4d4d, #be0d0d);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    /* Full navigation links for desktop view */
    .topnav .desktop-nav {
            position: sticky;
            top: 0;
            display: flex;
            margin: 0;
        }
        .desktop-nav a {
            color: white;
            padding: 16px 22px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s ease;
        }
        .desktop-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    /* Media queries for mobile responsiveness */
    @media screen and (max-width: 768px) {
    .topnav .menu-icon {
        display: block; /* Show hamburger icon on mobile */
    }
    .topnav .desktop-nav {
        display: none; /* Hide desktop nav on mobile */
    }
    .mobile-header {
        display: block; /* Show mobile header on mobile */
    }
}
    @media screen and (max-width: 600px) {
        .container {
            width: 90%;
            margin: 20px auto;
            padding: 15px;
        }
        button, .ac-button {
            font-size: 14px;
            padding: 8px;
        }
    }
    @media screen and (max-width: 400px) {
        .container {
            width: 95%;
        }
        button, .ac-button {
            font-size: 12px;
            padding: 6px;
        }
        h3 {
    font-size: 16px; /* Further reduce heading sizes */
}
h2{
    font-size: 19px;
}
h1{
    font-size: 20px;
    font-weight: bold;
}

            #container {
            height: 300px; /* Reduce chart height */
         }
        }
        @media screen and (max-width: 768px) {
    .desktop-header {
        display: none; /* Hide on mobile */
    }
}
        @media screen and (min-width: 769px) {
    .mobile-header {
        display: none; /* Hide mobile header on desktop */
    }
    .topnav {
            top: 0;
            }
     h3 {
           font-size: 16px; /* Further reduce heading sizes */
        }
}
 @media screen and (max-width: 768px) {
    .mobile-header {
        display: allow; /* Hide on mobile */
        color: white;
        text-align: center;
        flex-grow: 1;
    }
}
        .content {
            padding-left: 16px;
            margin-top: 80px; /* Add margin top to content area below sticky topnav */
        }
    </style>
</head>
<body>
<div class="topnav">
    <span class="menu-icon" onclick="openNav()">&#9776;</span><h1 class="mobile-header">Temperature chart</h1>

    <!-- Desktop navigation links -->
    <div class="desktop-nav">
        <a type="image" href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/heart.jpg">
        <img src="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/heart.jpg" width="28" height="28" alt="Heart Icon">
    </a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Temperature%20chart.html">Home&nbsp<i class="fa fa-home" ></i></a>
    <a class="active" href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Day%201.html">New chart&nbsp<i class="fa fa-thermometer"></i></a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/about.html">About this website&nbsp<i class="fa fa-globe"></i></a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Getting%20started.html">Getting started&nbsp<i class="fa fa-rocket"></i></a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Devoloper.html">Meet the developer&nbsp<i class="glyphicon glyphicon-user"></i></a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Convert%20to%20fahrenheit.html">Other accessories&nbsp<i class="fa fa-wrench"></i></a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/account.html" class="ac-button">Your account and saved files&nbsp<i class="fa fa-user"></i></a>
    </div>
</div>

<!-- Sidebar navigation -->
<div id="mySidebar" class="sidebar"><h1 style="padding-left: 16px;"></h1>
    <a href="javascript:void(0)" class="close-btn" onclick="closeNav()">&times;</a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Temperature%20chart.html">Home</a>
    <a class="active" href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Day%201.html">New chart</a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/about.html">About this website</a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Getting%20started.html">Getting started</a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Devoloper.html">Meet the developer</a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/Convert%20to%20fahrenheit.html">Other accessories</a>
    <a href="https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/account.html" class="ac-button">Your account and saved files</a>
</div>
    <div class="content">
        <h1>Record fever history</h1><br><br>
        <ul>
            <h2>
            <li>
                Why use record fever history chart?
                <h3>
                    <ul>
                        <li>It is used to record a series of body temperatures of a person. You can record it at any date and input any temperatures recorded at any day. </li>
                    </ul>
                </h3>
            </li>
                </h2>
        </ul>

        <br><br>

        <div id="printableArea">
            <div class="container">
                <h2>Details</h2>
                <label for="name">Name:</label>
                <input type="text" id="name" placeholder="Enter name">
                <label for="dob">Date of Birth:</label>
                <input type="date" id="dob">
                <button onclick="calculateAge()">Calculate Age</button>
                <p id="result"></p>
                <label for="startDate">Measured from:</label>
                <input type="date" id="startDate">
                <button onclick="generateChart()">Generate Chart</button>

                <h3>Add Data</h3>
                <label for="dateInput">Date:</label>
                <input type="date" id="dateInput">
                <label for="timeInput">Time (HH:MM):</label>
                <input type="time" id="timeInput">
                <label for="tempInput">Temperature (°F):</label>
                <input type="number" id="tempInput" step="0.1">
                <button onclick="addData()">Add Data</button>
            </div>

            <div id="container" style="width: 100%; height: 600px;"></div>
        </div>
    </div>
    <button id="toggleGridButton" class="save-button" onclick="toggleGrid()">Show Grid</button><br><br>
    <button id="saveButton" class="save-button">Save</button><br><br> <!-- Removed inline onclick -->
    <button class="save-button" onclick="printPrintableArea()">Print</button><br><br>
    <button id="shareGmail" class="save-button" onclick="shareGmail()">Share via Email</button><br><br>
    <button id="shareWhatsApp" class="save-button" onclick="shareWhatsApp()">Share via WhatsApp</button><br><br>
    <button id="newChartSheet" class="save-button" onclick="newChartSheet()">New Chart Sheet</button><br><br>

    <br>

<!-- Firebase SDKs -->
<!-- Using a recent version (10.11.0 as of this example), check Firebase docs for the latest recommended -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>

<script>
    // Your Firebase project configuration
    // *** REPLACE WITH YOUR ACTUAL CONFIG FROM THE FIREBASE CONSOLE! ***
    // Go to Project settings -> General -> Your apps -> Select your web app
    const firebaseConfig = {
      apiKey: "AIzaSyB_iG1hCwRs82h_EoLmVERfHKxO2fh-M-Q", // <-- Replace this!
      authDomain: "temperature-chart-47839.firebaseapp.com",
      projectId: "temperature-chart-47839",
      storageBucket: "temperature-chart-47839.firebasestorage.app",
      messagingSenderId: "764348196897",
      appId: "1:764348196897:web:10e513dc51e6e839665b60",
      // Add the databaseURL for Realtime Database
      databaseURL: "https://temperature-chart-47839-default-rtdb.asia-southeast1.firebasedatabase.app" // <-- Make sure this is correct
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);

    // Get references to the Auth and Database services
    const auth = app.auth();
    const database = app.database();

    console.log("Firebase SDKs initialized on Chart page (Five Days)!");

    // --- Firebase Authentication State Observer ---
    // Check auth state on page load and update UI elements like the Save button
    // This ensures the Save button is only enabled when a user is signed in
    auth.onAuthStateChanged(function(user) {
        const saveButton = document.getElementById('saveButton');
        if (saveButton) { // Check if the button exists on this page
             if (user) {
                 // User is signed in. Enable saving.
                 console.log("User signed in on Chart page (Five Days):", user.email, "UID:", user.uid);
                 saveButton.disabled = false; // Enable the save button
             } else {
                 // User is signed out. Disable saving.
                 console.log("No user signed in on Chart page (Five Days).");
                 saveButton.disabled = true; // Disable the save button
                 // You could also show a message explaining why saving is disabled
             }
        }
    });


    let chart; // Declare chart variable in a scope accessible by other functions
    // Global array to hold the temperature data points
    // Each point should be { x: timestamp, y: temperature, customTime: 'HH:MM' }
    const data = [];
    let isGridVisible = false; // Initialize grid visibility state

    // Function to calculate age
    function calculateAge() {
        const name = document.getElementById('name').value.trim(); // Use trim() to remove whitespace
        const dobInput = document.getElementById('dob').value;
        const resultElement = document.getElementById('result'); // Get result paragraph

        if (!dobInput || !name) {
            resultElement.innerText = 'Please enter both name and date of birth.';
            return;
        }

        const dob = new Date(dobInput);
        const today = new Date();

        // Check for valid date
        if (isNaN(dob.getTime())) {
             resultElement.innerText = 'Invalid date entered.';
             return;
        }

        let ageYears = today.getFullYear() - dob.getFullYear();
        let ageMonths = today.getMonth() - dob.getMonth();
        let ageDays = today.getDate() - dob.getDate();

        // Adjust age if birthday hasn't occurred this year/month
        if (ageDays < 0) {
            ageMonths--;
            // Calculate days in the previous month
            const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            ageDays += lastMonth.getDate();
        }

        if (ageMonths < 0) {
            ageYears--;
            ageMonths += 12;
        }

         // Handle cases for exactly birthday month/day
         if (today.getMonth() === dob.getMonth() && today.getDate() === dob.getDate() && ageYears >= 0) {
            resultElement.innerText = `${name} is ${ageYears} years old today! Happy Birthday!`;
         } else if (ageYears < 0) {
              resultElement.innerText = 'Date of birth is in the future.';
         }
         else if (ageYears === 0 && ageMonths === 0 && ageDays === 0) {
             resultElement.innerText = `${name} is less than a day old.`;
         }
         else {
             // Format the output string
             let ageString = `${name} is `;
             if (ageYears > 0) ageString += `${ageYears} year${ageYears > 1 ? 's' : ''}`;
             if (ageYears > 0 && ageMonths > 0) ageString += ', ';
             if (ageMonths > 0) ageString += `${ageMonths} month${ageMonths > 1 ? 's' : ''}`;
             if ((ageYears > 0 || ageMonths > 0) && ageDays > 0) ageString += ', and ';
             if (ageDays > 0 || (ageYears === 0 && ageMonths === 0)) ageString += `${ageDays} day${ageDays > 1 ? 's' : ''}`;

             resultElement.innerText = ageString + '.';
         }

    }

    // Function to generate or update the Highcharts chart
    function generateChart() {
        if (chart) {
            chart.destroy(); // Destroy previous chart instance if it exists
        }

        chart = Highcharts.chart('container', {
            chart: {
                type: 'line',
                events: {
                    // Click event to update a data point
                    click: function (event) {
                         // Find the nearest point to the click
                        const point = this.series[0].searchPoint(event, true);
                        if (point) {
                            // Prompt for a new temperature value
                            const newTemperature = prompt("Enter a new temperature value for " + Highcharts.dateFormat('%A, %dth of %m %Y %H:%M', point.x));
                            // Check if input is valid
                            if (newTemperature !== null && newTemperature.trim() !== '' && !isNaN(Number(newTemperature))) {
                                const updatedTemp = Number(newTemperature);
                                // Validate temperature range (optional but good practice)
                                if (updatedTemp >= 95 && updatedTemp <= 105) {
                                     // Update the point in the chart's series
                                    point.update(updatedTemp);

                                     // ALSO UPDATE THE DATA IN THE GLOBAL 'data' ARRAY
                                     // Find the corresponding point in the data array by timestamp
                                     const dataPointIndex = data.findIndex(p => p.x === point.x);
                                     if (dataPointIndex !== -1) {
                                         data[dataPointIndex].y = updatedTemp; // Update the value in the array
                                         console.log(`Updated temperature for timestamp ${point.x} to ${updatedTemp}`);
                                     }
                                } else {
                                     alert('Please enter a valid temperature value between 95 and 105.');
                                }
                            } else if (newTemperature !== null) { // If input was not null but invalid number
                                alert('Invalid number entered.');
                            }
                        }
                    }
                }
            },
            title: {
                text: 'Temperature Record'
            },
            xAxis: {
                type: 'datetime', // Use datetime axis for timestamps
                title: {
                    text: 'Time'
                },
                labels: {
                    format: '{value:%Y-%m-%d %H:%M}', // Format label to show Date and Time
                    rotation: -45, // Rotate labels to prevent overlap
                    style: {
                        fontSize: '10px'
                    }
                },
                 // Grid line settings based on global state
                gridLineWidth: isGridVisible ? 1 : 0,
                gridLineColor: isGridVisible ? '#53535381' : null
            },
            yAxis: [{ // Primary Y-axis (Fahrenheit)
                title: {
                    text: 'Temperature (°F)'
                },
                min: 95,
                max: 105,
                plotLines: [{ // Horizontal reference line at 98.4°F
                    color: 'rgba(255, 0, 0, 0.5)',
                    width: 1,
                    value: 98.4,
                    dashStyle: 'solid',
                    label: {
                        text: '98.4°F',
                        align: 'right',
                        style: {
                            color: 'red'
                        }
                    },
                    zIndex: 5
                }],
                 // Grid line settings based on global state
                gridLineWidth: isGridVisible ? 1 : 0,
                gridLineColor: isGridVisible ? '#53535381' : null
            }, { // Secondary Y-axis (Celsius)
                title: {
                    text: 'Temperature (°C)'
                },
                opposite: true, // Place on the right side
                min: (95 - 32) * 5 / 9, // Convert 95°F to Celsius
                max: (105 - 32) * 5 / 9, // Convert 105°F to Celsius
                labels: {
                    formatter: function () {
                        // Convert Fahrenheit value (this.value) to Celsius
                        return ((this.value - 32) * 5 / 9).toFixed(1); // Display Celsius with one decimal point
                    }
                }
            }],
            tooltip: {
                 // Custom tooltip to show Date, Time (from customTime), and Temps
                formatter: function () {
                    // this.x is the timestamp
                    // this.y is the temperature (°F)
                    // Access customTime stored in the point data
                    const point = this.point;
                    const customTime = point.customTime; // Get the saved customTime

                    // Check if customTime exists, otherwise format from timestamp
                    const displayTime = customTime || Highcharts.dateFormat('%H:%M', this.x);

                    return `<b>Date: </b>${Highcharts.dateFormat('%Y-%m-%d', this.x)}<br/>` +
                           `<b>Time: </b>${displayTime}<br/>` +
                           `<b>Temperature: </b>${this.y}°F / ${((this.y - 32) * 5 / 9).toFixed(1)}°C`;
                }
            },
            series: [{
                name: 'Temperature',
                yAxis: 0, // Link to the primary Y-axis (Fahrenheit)
                color: {
                    linearGradient: { x1: 0, y1: 0, x2: 1, y2: 0 },
                    stops: [
                        [0, '#6a11cb'],
                        [1, '#2575fc']
                    ]
                },
                 // Use the global data array for the series data
                data: data,
                dataLabels: {
                    enabled: true, // Show data labels on points
                    format: '{y}°F', // Format label to show temperature
                    style: {
                        color: '#000', // Label text color
                        fontSize: '10px',
                        textOutline: 'none' // Remove outline for better readability
                    }
                }
            }]
        });

        console.log("Chart generated or updated with data:", data);

}


    // Function to add data points from input fields
    function addData() {
        const dateInput = document.getElementById('dateInput').value;
        const timeInput = document.getElementById('timeInput').value;
        const tempInput = parseFloat(document.getElementById('tempInput').value);

        if (!dateInput || !timeInput || isNaN(tempInput)) {
            alert('Please enter a valid date, time, and temperature.');
            return;
        }

        // Combine date and time into a single Date object's timestamp
        const dateTimeString = `${dateInput}T${timeInput}`; // Format compatible with new Date()
        const dateTime = new Date(dateTimeString).getTime(); // Get Unix timestamp (milliseconds)

        // Validate temperature range (optional but good practice)
        if (tempInput < 95 || tempInput > 105) {
             alert('Please enter a temperature value between 95 and 105°F.');
             return;
        }


        // Check if a point with the same timestamp already exists to avoid duplicates
        const existingPointIndex = data.findIndex(point => point.x === dateTime);
        if (existingPointIndex !== -1) {
             const confirmOverwrite = confirm(`A temperature is already recorded at ${dateInput} ${timeInput}. Do you want to overwrite it?`);
             if (!confirmOverwrite) {
                 return; // Don't overwrite if user cancels
             }
              // If confirmed, remove the existing point before adding the new one
              data.splice(existingPointIndex, 1);
        }


        // Add the new data point to the global 'data' array
        // Store timestamp (x), temperature (y), and custom time string
        data.push({
            x: dateTime,
            y: tempInput,
            customTime: timeInput // Save the original time string for the tooltip
        });

        // Sort the data array by timestamp to ensure the line chart is correct
        data.sort((a, b) => a.x - b.x);

        console.log("Added Data Point:", { dateInput, timeInput, tempInput });
        console.log("Updated and Sorted Data Array:", data);

        // Update the chart with the new data
        if (chart) {
            // setData replaces all points. Pass the entire sorted 'data' array.
            // The second argument 'true' redraws the chart immediately.
            chart.series[0].setData(data, true);
        } else {
            alert('Please generate the chart first.');
        }

        // Clear input fields after adding data
        document.getElementById('dateInput').value = '';
        document.getElementById('timeInput').value = '';
        document.getElementById('tempInput').value = '';
         document.getElementById('dateInput').focus(); // Set focus back to the date input
    }


    // Function to calculate age (keeping your existing logic)
    function calculateAge() {
        const name = document.getElementById('name').value.trim(); // Use trim()
        const dobInput = document.getElementById('dob').value;
        const resultElement = document.getElementById('result'); // Get result paragraph

        if (!dobInput || !name) {
            resultElement.innerText = 'Please enter both name and date of birth.';
            return;
        }

        const dob = new Date(dobInput);
        const today = new Date();

        // Check for valid date
        if (isNaN(dob.getTime())) {
             resultElement.innerText = 'Invalid date entered.';
             return;
        }

        let ageYears = today.getFullYear() - dob.getFullYear();
        let ageMonths = today.getMonth() - dob.getMonth();
        let ageDays = today.getDate() - dob.getDate();

        // Adjust age if birthday hasn't occurred this year/month
        if (ageDays < 0) {
            ageMonths--;
            const lastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            ageDays += lastMonth.getDate();
        }

        if (ageMonths < 0) {
            ageYears--;
            ageMonths += 12;
        }

         // Handle cases for exactly birthday month/day
         if (today.getMonth() === dob.getMonth() && today.getDate() === dob.getDate() && ageYears >= 0) {
            resultElement.innerText = `${name} is ${ageYears} years old today! Happy Birthday!`;
         } else if (ageYears < 0) {
              resultElement.innerText = 'Date of birth is in the future.';
         }
         else if (ageYears === 0 && ageMonths === 0 && ageDays === 0) {
             resultElement.innerText = `${name} is less than a day old.`;
         }
         else {
             // Format the output string
             let ageString = `${name} is `;
             if (ageYears > 0) ageString += `${ageYears} year${ageYears > 1 ? 's' : ''}`;
             if (ageYears > 0 && ageMonths > 0) ageString += ', ';
             if (ageMonths > 0) ageString += `${ageMonths} month${ageMonths > 1 ? 's' : ''}`;
             if ((ageYears > 0 || ageMonths > 0) && ageDays > 0) ageString += ', and ';
             if (ageDays > 0 || (ageYears === 0 && ageMonths === 0)) ageString += `${ageDays} day${ageDays > 1 ? 's' : ''}`;

             resultElement.innerText = ageString + '.';
         }
    }

    // --- Save Chart Data to Firebase Realtime Database (with name prompt) ---
    // This function replaces the localStorage saving logic
    function saveChartData() {
        const user = auth.currentUser; // Get the currently logged-in user

        if (!user) {
            // If no user is logged in, inform them and stop.
            alert('Please sign in to your account to save charts.');
            // Optionally redirect to the sign-in page
            // window.location.href = 'https://mironroshanth.github.io/Peadiac-temperature-chart-RDM/Sign%20in.html'; // Use your actual sign-in page URL
            return;
        }

        const name = document.getElementById('name').value.trim(); // Patient name
        const dob = document.getElementById('dob').value;         // Patient DOB
        const startDate = document.getElementById('startDate').value; // Chart start date

        // Ensure chart data exists before trying to save
        const temperatures = chart && chart.series && chart.series[0] && chart.series[0].data.map(point => ({
            // Use the original timestamp (point.x) and value (point.y) from Highcharts data
            timestamp: point.x,
            value: point.y,
            customTime: point.customTime // Include the custom time string if available
        })) || []; // Use empty array if chart or data is not available


        if (!name || !dob || !startDate) { // Include startDate in required fields
            alert('Please enter patient name, date of birth, and chart start date before saving.');
            return;
        }

        if (temperatures.length === 0) {
            alert('Please add some temperature data to the chart before saving.');
            return;
        }

        // *** Add the prompt for the file name here ***
        const defaultFileName = name ? `${name} - ${new Date().toLocaleDateString()}` : `Chart - ${new Date().toLocaleDateString()}`;
        const fileNamePrompt = prompt('Enter a name to save this chart file:', defaultFileName);

        // Check if the user cancelled the prompt or entered an empty name
        if (!fileNamePrompt || fileNamePrompt.trim() === '') {
            alert('Saving cancelled. File name cannot be empty.');
            return; // Stop the save process
        }

        const uniqueFileName = fileNamePrompt.trim(); // Use the name provided by the user


        // Structure the data to be saved under the user's node in RTDB
        // We'll put it under `/patients/[userId]/files/[unique_file_key]`
        const fileDataToSave = {
            fileName: uniqueFileName, // *** Use the user-provided name here ***
            sourcePage: 'Temperatures recorded in all five days', // *** IMPORTANT: Use the correct identifier for THIS page ***
            timestamp: firebase.database.ServerValue.TIMESTAMP, // Server timestamp for when it was saved
            fileData: { // Nested object containing the actual chart data
                name: name, // Still include patient name, DOB, and startDate within the data
                dob: dob,
                startDate: startDate, // Include startDate here
                temperatures: temperatures
            }
        };

         // Get a reference to the user's files location in RTDB
         const userFilesRef = database.ref('patients/' + user.uid + '/files');

        // Use push() to generate a unique key and set() to save the data.
        // This creates a new entry for each saved chart.
        userFilesRef.push().set(fileDataToSave)
            .then(() => {
                console.log("Chart data saved successfully to Firebase RTDB!", { fileName: uniqueFileName });
                alert(`Chart data saved successfully as "${uniqueFileName}" in your account!`);
                // Optionally, redirect to the account page after saving
                 window.location.href = 'https://mironroshanth.github.io/Peadiatric-temperature-chart-RDM/account.html'; // Use your actual account page URL
            })
            .catch((error) => {
                console.error("Error saving chart data to Firebase RTDB:", error);
                alert('Error saving chart data: ' + error.message);
            });
    }
    // NOTE: Add the event listener for the save button below, outside this function definition.

    // Keeping your original print function, assuming it works as intended for the areaId
    function printPageArea(areaId) {
        const printContent = document.getElementById(areaId).innerHTML;
        const originalContent = document.body.innerHTML;
        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
    }

    // --- Load Chart Data from sessionStorage (from Account page) ---
    // This logic runs when the page loads to check if data was passed from the Account page
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Chart page (Five Days) DOMContentLoaded fired.");

        // Initialize Highcharts chart here initially with empty data,
        // it will be updated if data is loaded from sessionStorage.
        // This is important so 'chart' variable is defined even if no data is loaded.
         generateChart(); // Call generateChart to create the chart instance


        console.log("Checking sessionStorage for 'chartDataForLoad'...");
        const storedDataJSON = sessionStorage.getItem('chartDataForLoad'); // *** Use the correct key from Account page ***
        // console.log("sessionStorage value found:", storedDataJSON); // Uncomment for debugging

        if (storedDataJSON) { // Check if the JSON string exists
            try {
                const storedData = JSON.parse(storedDataJSON); // Parse the JSON string
                console.log("Parsed data from sessionStorage:", storedData); // Log the parsed object

                // Load name, dob, and startDate into the input fields
                document.getElementById('name').value = storedData.name || '';
                document.getElementById('dob').value = storedData.dob || '';
                document.getElementById('startDate').value = storedData.startDate || ''; // *** Load startDate ***
                console.log("Name, DOB, and Start Date loaded from sessionStorage.");


                // Load temperature data into the global 'data' array
                // and then update the chart.
                if (storedData.temperatures && Array.isArray(storedData.temperatures)) {
                    // Clear the existing 'data' array if it had any initial points
                    data.length = 0;
                    // Add loaded points to the 'data' array
                    storedData.temperatures.forEach(point => {
                        data.push({
                           x: point.timestamp,
                           y: point.value,
                           customTime: point.customTime || Highcharts.dateFormat('%H:%M', point.timestamp) // Ensure customTime exists
                        });
                    });

                    // Sort data after pushing loaded points
                     data.sort((a, b) => a.x - b.x);

                    // Update the chart with the loaded data
                    if (chart) {
                         chart.series[0].setData(data, true);
                         console.log("Chart data set successfully from sessionStorage.");
                    } else {
                         console.error("Chart object not initialized when attempting to load data.");
                    }

                } else {
                    console.warn("No valid temperature data array found in stored data from sessionStorage:", storedData.temperatures);
                     // If no valid temp data, ensure the chart is empty
                     if (chart) chart.series[0].setData([], true);
                }

                // Clear the sessionStorage data *after attempting to load*, regardless of success of parsing/setting
                // This prevents loading the same data again if the user navigates back and forth
                 console.log("Clearing sessionStorage data...");
                sessionStorage.removeItem('chartDataForLoad');
                sessionStorage.removeItem('loadedChartSourcePage'); // Also clear the source page key
                console.log("sessionStorage cleared.");

            } catch (e) {
                console.error("Error parsing stored chart data from sessionStorage:", e);
                alert("Error loading saved chart data.");
                // Clear potentially corrupt data to prevent future load attempts
                 sessionStorage.removeItem('chartDataForLoad');
                 sessionStorage.removeItem('loadedChartSourcePage');
                 // Clear the chart if there was a parsing error
                 if (chart) chart.series[0].setData([], true);
            }
        } else {
            console.log("No 'chartDataForLoad' found in sessionStorage.");
            // Chart remains empty (as initialized by generateChart()), ready for new entry
        }

        // --- Attach Event Listeners AFTER DOM is fully loaded and chart is initialized ---
        // This is the correct place to attach event listeners
        document.getElementById('saveButton').addEventListener('click', saveChartData);
        document.getElementById('addData').addEventListener('click', addData); // Attach addData listener here too
        document.getElementById('generateChart').addEventListener('click', generateChart); // Attach generateChart listener here

        // Listeners for other buttons called via inline onclick are fine, but adding
        // them here is generally a cleaner practice if you remove inline onclick.
        // Example: document.getElementById('toggleGridButton').addEventListener('click', toggleGrid);
        // document.getElementById('newChartSheet').addEventListener('click', newChartSheet);
        // document.getElementById('shareGmail').addEventListener('click', shareGmail);
        // document.getElementById('shareWhatsApp').addEventListener('click', shareWhatsApp);
        // document.getElementById('printPrintableArea').addEventListener('click', printPrintableArea);


    }); // End of DOMContentLoaded listener

    // --- Function Definitions (OUTSIDE of DOMContentLoaded) ---

    // calculateAge function is already defined above

    // generateChart function is already defined above

    // addData function is already defined above

    // saveChartData function is already defined above

    // printPageArea function is already defined above

    // Function to clear the chart and inputs for a new sheet
    function newChartSheet() {
        // Clear all input fields
        document.getElementById('name').value = '';
        document.getElementById('dob').value = '';
        document.getElementById('startDate').value = ''; // Clear start date
        document.getElementById('dateInput').value = '';
        document.getElementById('timeInput').value = '';
        document.getElementById('tempInput').value = '';
        document.getElementById('result').innerText = ''; // Clear age result

        // Clear the global data array
        data.length = 0;
        console.log("Global data array cleared:", data);

        // Clear the chart data
        if (chart) {
            console.log("Clearing chart data...");
            chart.series[0].setData([], true);
             chart.series[0].setData([], true);
             console.log("Chart data cleared.");
        } else {
            console.log("Chart object not found when attempting to clear data.");
        }


        alert('Chart and inputs cleared for new entry!');
         console.log("Chart sheet cleared for new entry.");
    }

    // Function to toggle the grid lines on the chart
    // Called by onclick="toggleGrid()"
    function toggleGrid() {
        isGridVisible = !isGridVisible; // Toggle grid visibility state

        // Update chart options for grid lines
        // This will trigger a chart redraw
        if (chart) { // Ensure chart exists
             chart.update({
                 xAxis: {
                     gridLineColor: isGridVisible ? '#53535381' : null, // Use semi-transparent grey when visible
                     gridLineWidth: isGridVisible ? 1 : 0 // Set width to 1 when visible, 0 when hidden
                 },
                 yAxis: [{ // Apply to the primary Y-axis (Fahrenheit)
                     gridLineColor: isGridVisible ? '#53535381' : null,
                     gridLineWidth: isGridVisible ? 1 : 0
                 }, { // Apply to the secondary Y-axis (Celsius)
                      gridLineColor: isGridVisible ? '#53535381' : null,
                      gridLineWidth: isGridVisible ? 1 : 0
                 }]
             }, true); // Second argument 'true' makes it redraw

             const button = document.getElementById('toggleGridButton');
             if (button) { // Ensure button exists
                 button.innerText = isGridVisible ? 'Hide Grid' : 'Show Grid'; // Update button text
             }
             console.log("Grid visibility toggled:", isGridVisible);
        } else {
            console.warn("Cannot toggle grid, chart object not initialized.");
        }
    }

     // Function to open the sidebar navigation
     // Called by onclick="openNav()"
    function openNav() {
        document.getElementById("mySidebar").style.width = "250px"; // Set the width of the sidebar when opened
        console.log("Sidebar opened.");
    }

    // Function to close the sidebar navigation
    // Called by onclick="closeNav()"
    function closeNav() {
        document.getElementById("mySidebar").style.width = "0"; // Set the width of the sidebar to 0 when closed
         console.log("Sidebar closed.");
    }

     // Function to share chart data via Gmail
     // Called by onclick="shareGmail()"
    function shareGmail() {
        // Get data from input fields and chart series
        const name = document.getElementById('name').value.trim();
        const dob = document.getElementById('dob').value;
        const startDate = document.getElementById('startDate').value; // Get start date

        // Check if chart exists and has data
        const temperatures = chart && chart.series && chart.series[0] && chart.series[0].data.map(point => ({
            timestamp: point.x,
            value: point.y,
             customTime: point.customTime // Include custom time
        })) || []; // Use empty array if no data

        if (!name || !dob || !startDate || temperatures.length === 0) {
            alert('Please enter patient details, chart start date, and add temperature data before sharing.');
            return;
        }

        // Format temperature data for email body
        const temperatureList = temperatures.map(p => {
             const date = new Date(p.timestamp);
             // Format timestamp to a readable date/time string
             const formattedTime = date.toLocaleString(); // Adjust format as needed
             return `${formattedTime}: ${p.value}°F (${((p.value - 32) * 5 / 9).toFixed(1)}°C)`; // Include Celsius
        }).join('\n'); // Join points with newline

        const emailBody = `Patient Name: ${name}\nDate of Birth: ${dob}\nChart Start Date: ${startDate}\n\nTemperature Records:\n${temperatureList}`;
        const mailtoLink = `mailto:?subject=${encodeURIComponent('Temperature Chart Data for ' + name)}&body=${encodeURIComponent(emailBody)}`;

        window.location.href = mailtoLink; // Open default email client
         console.log("Attempting to share via Gmail.");
    }

    // Function to share chart data via WhatsApp
    // Called by onclick="shareWhatsApp()"
    function shareWhatsApp() {
        // Get data from input fields and chart series
        const name = document.getElementById('name').value.trim();
        const dob = document.getElementById('dob').value;
         const startDate = document.getElementById('startDate').value; // Get start date

        // Check if chart exists and has data
        const temperatures = chart && chart.series && chart.series[0] && chart.series[0].data.map(point => ({
            timestamp: point.x,
            value: point.y,
            customTime: point.customTime // Include custom time
        })) || []; // Use empty array if no data

         if (!name || !dob || !startDate || temperatures.length === 0) {
             alert('Please enter patient details, chart start date, and add temperature data before sharing.');
             return;
         }

        // Format temperature data for WhatsApp message (more compact)
         const temperatureList = temperatures.map(p => {
            const date = new Date(p.timestamp);
            // Format timestamp to a more compact date/time string for message
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Month is 0-indexed
            // Use customTime if available, otherwise format from timestamp
            const displayTime = p.customTime || `${hours}:${minutes}`;
            return `${day}/${month} ${displayTime}: ${p.value}°F/${((p.value - 32) * 5 / 9).toFixed(1)}°C`; // Include Celsius
         }).join(' | '); // Join points with a separator

        const message = `Temperature Chart Data:\nPatient: ${name}\nDOB: ${dob}\nFrom: ${startDate}\nTemps: ${temperatureList}`;
        const whatsappLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;

        window.open(whatsappLink, '_blank'); // Open WhatsApp share link in new tab
         console.log("Attempting to share via WhatsApp.");
    }

     // Function to print the designated printable area
     // Called by onclick="printPrintableArea()"
    function printPrintableArea() {
        const printableArea = document.getElementById('printableArea');
         if (!printableArea) {
             console.error("Printable area element not found.");
             alert("Could not find the area to print.");
             return;
         }

        const newWindow = window.open('', '_blank'); // Open a new blank window
        newWindow.document.write(`
            <html>
            <head>
                <title>Temperature Chart Print</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 20px;
                    }
                    h1, h2, h3 {
                        color: #333;
                    }
                    /* Include any specific print styles here if needed */
                    /* For Highcharts printing, you might need specific CSS or Highcharts export module */
                     #container {
                         width: 100% !important; /* Ensure chart uses full width in print */
                         height: auto !important; /* Allow height to adjust */
                     }
                    /* Hide buttons/inputs in the printed output if they are within printableArea */
                    button, input, label {
                         display: none !important;
                    }
                    /* Ensure necessary elements like headers and text are visible */
                    h2, label[for="name"], label[for="dob"], label[for="startDate"], #result {
                         display: block !important;
                         margin-bottom: 5px !important;
                    }
                    /* Display patient info as text */
                    #printableArea .container {
                        padding: 0 !important; /* Remove padding in print */
                        box-shadow: none !important; /* Remove shadow in print */
                         margin: 0 0 20px 0 !important; /* Add margin below details */
                         border: none !important;
                         background-color: transparent !important;
                    }
                    #printableArea .container input {
                        display: none !important; /* Hide inputs in print */
                    }
                     #printableArea .container label[for="name"]::after { content: ": " attr(value); font-weight: normal; }
                     #printableArea .container label[for="dob"]::after { content: ": " attr(value); font-weight: normal; }
                     #printableArea .container label[for="startDate"]::after { content: ": " attr(value); font-weight: normal; }

                </style>
            </head>
            <body onload="window.print(); window.close();">
                <h1>Record fever history</h1>
                 <!-- Manually write details from input fields for printing -->
                 <div>
                     <h2>Details</h2>
                     <p><b>Name:</b> ${document.getElementById('name').value.trim()}</p>
                     <p><b>Date of Birth:</b> ${document.getElementById('dob').value}</p>
                     <p><b>Measured from:</b> ${document.getElementById('startDate').value}</p>
                     ${document.getElementById('result').innerText ? `<p>${document.getElementById('result').innerText}</p>` : ''}
                 </div>
                <!-- Include the chart container -->
                ${document.getElementById('container').outerHTML}
            </body>
            </html>
        `);
        newWindow.document.close(); // Close the document to finish writing

        // A small delay before printing to ensure content renders
        setTimeout(() => {
            // Highcharts typically handles printing well when it's in the DOM
            // before print is called. The onload in body tag helps.
        }, 500); // 500ms delay
         console.log("Initiated printing of printable area.");
    }


    // --- Make functions globally available for inline onclick attributes ---
    // If you use `addEventListener` for all buttons within DOMContentLoaded,
    // you can remove these window assignments.
    window.calculateAge = calculateAge;
    // window.generateChart is attached via addEventListener in DOMContentLoaded
    // window.addData is attached via addEventListener in DOMContentLoaded
    // window.saveChartData is attached via addEventListener in DOMContentLoaded
    window.newChartSheet = newChartSheet;
    window.toggleGrid = toggleGrid;
    window.openNav = openNav;
    window.closeNav = closeNav;
    window.shareGmail = shareGmail;
    window.shareWhatsApp = shareWhatsApp;
    window.printPrintableArea = printPrintableArea;

    // Assuming goBack is defined somewhere globally:
    // function goBack() { window.history.back(); }
    // window.goBack = goBack;

</script>
</body>
</html>
